import java.io.*;

public class CSVBatchConverter {

    public static void main(String[] args) {
        File inputFolder = new File("C:\\InputCSVs");      // Folder with subfolders or CSVs
        File outputFolder = new File("C:\\OutputSQLs");    // Destination folder for .txt files

        if (!outputFolder.exists()) {
            outputFolder.mkdirs();
        }

        File[] csvFiles = inputFolder.listFiles((dir, name) -> name.toLowerCase().endsWith(".csv"));

        if (csvFiles == null || csvFiles.length == 0) {
            System.out.println("No CSV files found in input folder.");
            return;
        }

        for (File csvFile : csvFiles) {
            String baseName = csvFile.getName().replaceFirst("[.][^.]+$", "");
            File outputFile = new File(outputFolder, baseName + ".txt");

            // Use parent folder name as table name
            String tableName = csvFile.getParentFile().getName();

            convertCsvToIndividualDb2Inserts(csvFile, outputFile, tableName);
        }

        System.out.println("All CSV files converted successfully.");
    }

    public static void convertCsvToIndividualDb2Inserts(File csvFile, File outputFile, String tableName) {
        try (BufferedReader br = new BufferedReader(new FileReader(csvFile));
             BufferedWriter bw = new BufferedWriter(new FileWriter(outputFile))) {

            String line;

            // Skip header
            br.readLine();

            while ((line = br.readLine()) != null) {
                if (line.trim().isEmpty()) continue;

                String[] parts = line.split(",", -1);
                StringBuilder pipeSeparated = new StringBuilder();
                for (int i = 0; i < parts.length; i++) {
                    if (i > 0) pipeSeparated.append("|");
                    pipeSeparated.append(parts[i]);
                }

                String formattedValues = StringFormatter.convertForDB2(pipeSeparated.toString());
                bw.write("INSERT INTO " + tableName + " VALUES " + formattedValues + ";");
                bw.newLine();
            }

            System.out.println("Converted: " + csvFile.getName() + " â†’ " + outputFile.getName());

        } catch (IOException e) {
            System.err.println("Error processing " + csvFile.getName() + ": " + e.getMessage());
        }
    }
}
